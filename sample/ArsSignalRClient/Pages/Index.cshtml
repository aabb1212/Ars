@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p>Learn about <a href="https://docs.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
</div>

<script src="~/lib/signalr/signalr.js"></script>
<script src="~/lib/signalr/signalr-protocol-msgpack.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("https://127.0.0.1:5225/ws/webapi/web/hub?group=g2", {
            accessTokenFactory: () => {
                //return "eyJhbGciOiJSUzI1NiIsImtpZCI6IkRDOEQyMzQ5NzFFMzQ4NUYzNjQzQTI5NzY2NEQ3MUZFNjU4MjZCQjZSUzI1NiIsInR5cCI6ImF0K2p3dCIsIng1dCI6IjNJMGpTWEhqU0Y4MlE2S1haazF4X21XQ2E3WSJ9.eyJuYmYiOjE2ODM3Njk3NjUsImV4cCI6MTY4Mzc3MzM2NSwiaXNzIjoiaHR0cHM6Ly8xNzIuMjAuNjQuMTo1MTA1IiwiYXVkIjoiYXBpSWRzNEZpcnN0IiwiY2xpZW50X2lkIjoiZ3JwYy1rZXkiLCJzdWIiOiIxMjMiLCJhdXRoX3RpbWUiOjE2ODM3Njk3NjUsImlkcCI6ImFycyIsInRlbmFudCI6IjEiLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOiJhZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiSDEyMyIsImp0aSI6IjYxOERGQUVFQzRCRERDNEJEMTZBNjYxQzc0NkZBN0I0IiwiaWF0IjoxNjgzNzY5NzY1LCJzY29wZSI6WyJncnBjYXBpLXNjb3BlIiwib2ZmbGluZV9hY2Nlc3MiXSwiYW1yIjpbIkJlYXJlciJdfQ.MVE1qV3oAk9wN5ylsJC-0S9XLSMgihMaI_d406hjDwYAjMtIazk1tznlmQf-57AOsUxW2aDDLSI3j5pfS8m10cJdUEUC_yXbCAcUhESwSgT3JM13M7a2ypwYbSH-KOijyBVej0gI5zZ-hpVBgOAgshjDjsdydL8GdNdDbpSFh3919apUwKTBmz9igDGm66r995Q365UiiZPOedCzYXUD7MBat3_TLul_8WoNUSv6Fogu0S3O6Fplr39g31GsGD53LCCGVOt546sMpflP9fydtScb7qnTCcZ-7HB8MnrJMVc5kGMt_anUTKUSV01NUj8goAxYws3B6801i7e7_jQ6Og";
            }
        })
        .withHubProtocol(new signalR.protocols.msgpack.MessagePackHubProtocol())
        .withAutomaticReconnect()
        .configureLogging(signalR.LogLevel.Information)
        .build();

    async function start() {
        try {
            connection.logging = true;
            await connection.start();
            console.log("SignalR Connected.");
        } catch (err) {
            console.log(err);
            setTimeout(start, 5000);
        }
    };

    connection.onclose(async () => {
        console.log("SignalR DisConnected.");
        await start();
    });

    connection.on("产线01.站台A7.ReceiveMessage", (message) => {
        console.log(`产线01.站台A7.ReceiveMessage:${message}`);
    });

    connection.on("ars.hub.ReceiveMessage",(message) =>{
        console.log(message);
    });

    // Start the connection.
    start();
</script>